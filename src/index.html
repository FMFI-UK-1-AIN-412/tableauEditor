<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Tableau Editor</title>
    <script type="text/javascript" src="/_compile/src/Editor.elm"></script>
    <link rel="stylesheet" href="editor.css">
  </head>
  <body>
  </body>
  <script type="text/javascript">
    /* https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding */
    function b64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }
    var cachedTableau = localStorage.getItem('oldTableauEditor');
    var app = Elm.Editor.init({
      flags: cachedTableau ? cachedTableau : null
    });
    app.ports.fileSelected.subscribe(function (id) {
      var node = document.getElementById(id);
      if (node === null) {
        return;
      }
      var file = node.files[0];
      if (!file)
        return;
      var reader = new FileReader();
      reader.onload = (function(event) {
        var dataUri = event.target.result;
        var base64encoded = dataUri.replace(/^[^,]*,/,"");
        var data = b64DecodeUnicode(base64encoded);
        var portData = {
          contents: data,
          filename: file.name
        };
        app.ports.fileContentRead.send(portData);
      });
      reader.readAsDataURL(file);
    });
    app.ports.selectFile.subscribe(function (id) {
      var node = document.getElementById(id);
      if (node === null) {
        return;
      }
      node.click();
    });
    app.ports.print.subscribe(function () {
      window.print();
    });
    app.ports.cache.subscribe(function (tableau) {
      localStorage.setItem('oldTableauEditor', tableau);
    });
  </script>
</html>
<!-- vim: set sw=2 ts=2 sts=2 et : -->
